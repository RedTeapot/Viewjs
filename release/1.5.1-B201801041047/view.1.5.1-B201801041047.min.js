/**
 * View.js v1.5.1-B201801041047
 * author: Billy, wmjhappy_ok@126.com
 * license: MIT
 */
!function(ctx,name){var setDftValue=function(e,t,i){arguments.length<3&&(i=!1),e=e||{},t=t||{};for(var n in t)n in e&&!(n in e&&null==e[n]&&i)||(e[n]=t[n]);return e},defineReadOnlyProperty=function(e,t,i){Object.defineProperty(e,t,{value:i,configurable:!1,writable:!1,enumerable:!0})},try2exec=function(e,t,i){if(null!=e&&"function"==typeof e)try{e.apply(t,i)}catch(t){var n=t instanceof Error||null!=t&&"object"==typeof t&&"stack"in t,r="Error occured while executing function: {}. {}"+(n?" stack:\n{}":"");globalLogger.error(r,e.name,t,n?t.stack:null)}},try2Call=function(func,ctx,args){if(null!=func&&"function"==typeof func)try{for(var tmp="",index=2,i=2;i<arguments.length;i++)tmp+=",arguments["+i+"]";eval("func.call(ctx"+tmp+")")}catch(e){var isError=e instanceof Error||null!=e&&"object"==typeof e&&"stack"in e,s="Error occured while executing function: {}. {}"+(isError?" stack:\n{}":"");globalLogger.error(s,func.name,e,isError?e.stack:null)}},isEmptyString=function(e,t){return arguments.length<2&&(t=!1),null===e||void 0===e||(e=String(e),t&&(e=e.trim()),0==e.length)},isNullOrUndefined=function(e){return null===e||void 0===e},ifStringEquals=function(e,t,i,n){return arguments.length<4&&(n=!0),arguments.length<3&&(i=!0),isNullOrUndefined(e)?!!isNullOrUndefined(t):!isNullOrUndefined(t)&&(n&&(e=String(e).trim(),t=String(t).trim()),i||(e=e.toLowerCase(),t=t.toLowerCase()),e===t)},ifStringEqualsIgnoreCase=function(e,t,i){return arguments.length<3&&(i=!0),ifStringEquals(e,t,!1,i)},randomString=function(){var e="0123456789abcdefghijklmnopqrstuvwxyz";return function(t){arguments.length<1&&(t="");for(var i=10,n="";i-- >0;){var r=Math.floor(Math.random()*e.length);n+=e.charAt(r)}return t+n}}(),xEncodeURIComponent=function(e){return encodeURIComponent(String(e)).replace(/\+/gm,"%2B")},getUniqueString=function(){var e=0;return function(){var t=Date.now(),i=t.toString(36),n="00"+(e++).toString(36);return n=n.substring(n.length-2),(i+n).toUpperCase()}}(),eventDrive=function(){var e=function(e,t){this.type=e,this.timestamp=(new Date).getTime(),this.data=t,Object.freeze&&Object.freeze(this)};return function(t,i){var n={},r=function(e){n[e]=n[e]||[]};t.on=function(e,t){String(e).replace(/(\s*,){2,}/,",").toLowerCase().split(/\s*,\s*/).forEach(function(e){r(e),n[e].indexOf(t)==-1&&n[e].push(t)})},t.off=function(e,t){String(e).replace(/(\s*,){2,}/,",").toLowerCase().split(/\s*,\s*/).forEach(function(e){r(e);var i=n[e].indexOf(t);i!=-1&&n[e].splice(i,1)})},t.fire=function(t,o,a){arguments.length<3&&(a=!0),String(t).replace(/(\s*,){2,}/,",").toLowerCase().split(/\s*,\s*/).forEach(function(t){var u=new e(t,o),l=function(){r(t),n[t].forEach(function(e){"function"==typeof e&&try2Call(e,i,u)})};a?setTimeout(l,0):l()})}}}(),env=function(){var e=navigator.userAgent,t=/(?:MQQBrowser|QQ)/.test(e),i=/(?:UCWEB|UCBrowser)/.test(e),n=/(?:Safari)/.test(e),r=/(?:Opera Mini)/.test(e),o=/(?:Mac OS)/.test(e),a=/(?:Android)/.test(e),u=/(?:Windows Phone)/.test(e),l=o&&/(?:iPad)/.test(e),s=o&&/(?:iPhone)/.test(e),c=/(?:Tablet|PlayBook)/.test(e)||l,f=/(?:Mobile)/.test(e)&&!l||u;return{isQB:t,isUC:i,isSafari:n,isOpera:r,isIOS:o,isAndroid:a,isWindowsPhone:u,isIPad:l,isIPhone:s,isTablet:c,isMobile:f,isPc:!f&&!c}}(),Logger=function(){var e,t,i=function(){if(0!=arguments.length){var e=arguments,t=" "+String(arguments[0]),i=1;return t=t.replace(/([^\\])\{\}/g,function(t,n){var o=e.length-1<i?"{}":String(r(e[i]));return i++,n+o}),t=t.replace(/\\\{\}/g,"{}"),t.substring(1)}},n=function(){var e=new Date,t=(e.getFullYear(),"0"+String(e.getMonth()+1));t=t.substring(t.length-2);var i="0"+String(e.getDate());i=i.substring(i.length-2);var n="0"+String(e.getHours());n=n.substring(n.length-2);var r="0"+String(e.getMinutes());r=r.substring(r.length-2);var o="0"+String(e.getSeconds());return o=o.substring(o.length-2),t+i+" "+n+":"+r+":"+o},r=function(e){if(null==e)return null;if("number"==typeof e||"string"==typeof e||"boolean"==typeof e)return e;if("function"==typeof e)return"function "+e.name+"(){...}";if(e instanceof Array||"object"!=typeof e)return e instanceof Array?JSON.stringify(e.map(function(e){return r(e)})):e;if("[object Object]"!=String(e))return String(e);try{var t={};for(var i in e)t[i]=r(e[i]);return JSON.stringify(t)}catch(t){return String(e)}},o=function(e){return n()+" ["+e+"]: "},a={};!function(){var i=!0;e=function(){return i},t=function(e){i=e}}();var u=function(t){var n=!0;this.isEnabled=function(){return e()&&n},this.setIsEnabled=function(e){return n=e,this},this.getName=function(){return t},this.debug=function(){if(this.isEnabled()){var e=i.apply(null,arguments);console.debug(o(t)+e)}},this.info=function(){if(this.isEnabled()){var e=i.apply(null,arguments);console.info(o(t)+e)}},this.warn=function(){if(this.isEnabled()){var e=i.apply(null,arguments);console.warn(o(t)+e)}},this.error=function(){if(this.isEnabled()){var e=i.apply(null,arguments);console.error(o(t)+e)}},this.log=function(){if(this.isEnabled()){var e=i.apply(null,arguments);console.log(o(t)+e)}}},l=function(e){if(e in a)return a[e];var t=new u(e);return a[e]=t,t};return u.ofName=l,u.isGloballyEnabled=e,u.setIsGloballyEnabled=t,u}(),touch=function(){var e=/mobile|tablet|ip(ad|hone|od)|android/i,t=(window,e.test(navigator.userAgent)),i="  __com.soft.plugin.touch#"+(new Date).getTime()+"__  ",n=function(e,t){return e=e||{},e[t]=e[t]||{},e[t]};return{addTapListener:function(e,r,o){if(!t)return void(e.addEventListener?e.addEventListener("click",r):e.attachEvent("onclick",r));var a=n(e,i+".tap");if(a.callbacks=a.callbacks||[],a.callbacks.indexOf(r)==-1){a.callbacks.push(r),o=setDftValue(o,{timespan:500,delta:{},useCapture:!1}),o.delta=setDftValue(o.delta,{x:10,y:15});var u=n(e,i+".tap.meta");null==u.touchstart&&(u.touchstart=function(e){var t=e.changedTouches?e.changedTouches[0]:e;a.startX=t.screenX,a.startY=t.screenY,a.startTimestamp=Date.now()},e.addEventListener("touchstart",u.touchstart)),null==u.touchend&&(u.touchend=function(t){var i=t.changedTouches?t.changedTouches[0]:t;a.stopX=i.screenX,a.stopY=i.screenY,a.stopTimestamp=Date.now();var n=a.stopTimestamp-a.startTimestamp,r=Math.abs(a.stopX-a.startX),u=Math.abs(a.stopY-a.startY);n<=o.timespan&&r<=o.delta.x&&u<=o.delta.y&&a.callbacks.forEach(function(i){i&&i.call(e,t)})},e.addEventListener("touchend",u.touchend,o.useCapture))}},removeTapListener:function(e,r,o){if(!t)return void(e.removeEventListener?e.removeEventListener("click",r):e.detachEvent("onclick",r));if(e.hasOwnProperty(i)){var a=n(e,i+".tap"),u=a.callbacks.indexOf(r);if(u!=-1&&(a.callbacks.splice(u,1),0==a.callbacks.length)){var l=n(e,i+".tap.meta");e.removeEventListener("touchstart",l.touchstart),e.removeEventListener("touchend",l.touchend,o),delete e[i].tap}}}}}(),resolution=function(){var e=[],t=function(t){setTimeout(function(){e.forEach(function(e){try2Call(e,null,t)})},0)},i=function(){var e=document.documentElement;return e.clientWidth<=e.clientHeight},n=function(){var e=document.documentElement;return e.clientWidth>e.clientHeight},r=function(){var e=!1,n=-1,o=i(),a=function(){e=!0,n=Date.now()},u=function(){e=!1,n=-1},l=function(e){o==i()?setTimeout(r,20):(u(),o=i(),t(e))};return u(),function(t){if(e){Date.now()-n<500?l(t):(globalLogger.warn("Orientation remains the same."),u())}else a(),l(t)}}();"onorientationchange"in window?window.addEventListener("onorientationchange",r):window.addEventListener("resize",t);var o=function(t){e.indexOf(t)==-1&&e.push(t)},a={isPortrait:i,isLandscape:n,addChangeListener:o};return Object.freeze&&Object.freeze(a),a}(),layout=function(){var e=320/568,t=!0,i=[],n={},r=function(){return docEle.querySelector("["+attr$view_container+"]")||document.body},o=function(){return r().clientWidth},a=function(){return r().clientHeight},u=function(){return docEle.clientWidth},l=function(){return docEle.clientHeight},s=function(){return o()<=a()},c=function(){return!isPortrait()},f=function(){return u()<=l()},g=function(){return!f()},w=function(){return u()/l()},d=function(){return u()/l()},h=function(){return e},v=function(t){return e=t,n},p=function(e,t){var i=this,n=i.style;n.width=e+"px",n.height=t+"px"},V=p,y=V,m=y,b=V,S=b,I=m,E=I,L=V,P=L,O=m,A=O,C=function(){var e=u(),t=l();try2Call(g()?m:V,r(),e,t)},T=function(){var e=u(),t=l();try2Call(g()?E:S,r(),e,t)},D=function(){var t=u(),i=l();f()?try2Call(P,r(),t,i):A===O?(t=i*e,try2Call(V,r(),t,i)):try2Call(A,r(),t,i)},k=function(e){if(i.indexOf(e)==-1)return i.push(e),n},N=function(e){var t=i.indexOf(e);if(t!=-1)return i.splice(t,1),n},R=function(){var e=o(),t=a();env.isPc?D():env.isTablet?T():C();var r=o(),s=a(),c=u(),f=l();return(Math.abs(e-r)>=.1||Math.abs(t-s)>=.1)&&setTimeout(function(){globalLogger.debug("Layout changes. Layout: {} * {}, browser: {} * {}",r,s,c,f),i.forEach(function(e){"function"==typeof e&&try2Call(e,null,r,s,c,f)})},0),n};return setDftValue(n,{getLayoutWidth:o,getLayoutHeight:a,getBrowserWidth:u,getBrowserHeight:l,isLayoutPortrait:s,isLayoutLandscape:c,isBrowserPortrait:f,isBrowserLandscape:g,getLayoutWidthHeightRatio:w,getBrowserWidthHeightRatio:d,getExpectedWidthHeightRatio:h,setExpectedWidthHeightRatio:v,init:function(e){return e=setDftValue(e,{autoReLayoutWhenResize:!0,layoutAsMobilePortrait:V,layoutAsMobileLandscape:m,layoutAsTabletLandscape:E,layoutAsTabletPortrait:S,layoutAsPcPortrait:P,layoutAsPcLandscape:A}),t=!!e.autoReLayoutWhenResize,t&&resolution.addChangeListener(R),"function"==typeof e.layoutAsMobilePortrait&&(V=e.layoutAsMobilePortrait),"function"==typeof e.layoutAsMobileLandscape&&(m=e.layoutAsMobileLandscape),"function"==typeof e.layoutAsTabletPortrait&&(S=e.layoutAsTabletPortrait),"function"==typeof e.layoutAsTabletLandscape&&(E=e.layoutAsTabletLandscape),"function"==typeof e.layoutAsPcPortrait&&(P=e.layoutAsPcPortrait),"function"==typeof e.layoutAsPcLandscape&&(A=e.layoutAsPcLandscape),n},doLayout:R,addLayoutChangeListener:k,removeLayoutChangeListener:N}),Object.freeze&&Object.freeze(n),n}(),globalLogger=Logger.ofName("View"),docEle=document.documentElement,NOT_SUPPLIED=new Object,PSVIEW_BACK=":back",PSVIEW_FORWARD=":forward",PSVIEW_DEFAULT=":default-view",viewInstances=[],readyViews=[],viewParameters={},viewSwitchAnimation=null,attr$view="data-view",attr$view_default="data-view-default",attr$view_directly_accessible="data-view-directly-accessible",attr$view_group="data-view-group",attr$view_fallback="data-view-fallback",attr$view_rel="data-view-rel",attr$view_rel_disabled="data-view-rel-disabled",attr$view_rel_type="data-view-rel-type",attr$view_title="data-view-title",attr$view_container="data-view-container",attr$view_os="data-view-os",historyPushPopSupported="pushState"in history&&"function"==typeof history.pushState;globalLogger.log("History pushState is "+(historyPushPopSupported?"":"not ")+"supported");var isPseudoView=function(e){return":back"==e||":forward"==e||":default-view"==e},setViewParameter=function(e,t,i){if(!View.ifExists(e)&&!isPseudoView(e))throw new Error("View of id: "+e+" does not exist.");if(arguments.length<3)throw new Error("Invalid argument length. Both parameter name and value should be specified.");return viewParameters[e]=viewParameters[e]||{},viewParameters[e][String(t)]=i,View},setViewParameters=function(e,t){if(!View.ifExists(e)&&!isPseudoView(e))throw new Error("View of id: "+e+" does not exist.");if(void 0===t&&(t=null),"object"!=typeof t)throw new Error("Parameters specified should be an object or null.");return viewParameters[e]=t,View},clearViewParameters=function(e){return delete viewParameters[e],View},getViewObjs=function(){return document.querySelectorAll("*[data-view=true]")},getViewObjOfId=function(e){return document.querySelector("#"+e+"[data-view=true]")},ViewState=function(){var e=randomString("ViewState_"),t=function(t,i,n){arguments.length<3&&(n=null),arguments.length<2&&(i=getUniqueString()),i=i||getUniqueString(),defineReadOnlyProperty(this,"viewId",t),defineReadOnlyProperty(this,"sn",i),defineReadOnlyProperty(this,"options",n),defineReadOnlyProperty(this,"flag",e),this.toString=function(){return JSON.stringify(this)},this.clone=function(){return JSON.parse(this.toString())}};return t.isConstructorOf=function(e){return null!=e&&"object"==typeof e&&(e.hasOwnProperty("viewId")&&e.hasOwnProperty("sn")&&String(e.flag).startsWith("ViewState_"))},t}(),OperationState=function(){var e=randomString("OperationState_"),t=function(t,i){arguments.length<2&&(timeBasedUniqueString=getUniqueString()),timeBasedUniqueString=timeBasedUniqueString||getUniqueString(),defineReadOnlyProperty(this,"serialNumber",t),defineReadOnlyProperty(this,"sn",timeBasedUniqueString),defineReadOnlyProperty(this,"flag",e),this.toString=function(){return JSON.stringify(this)},this.clone=function(){return JSON.parse(this.toString())}};t.isConstructorOf=function(e){return null!=e&&"object"==typeof e&&(e.hasOwnProperty("serialNumber")&&e.hasOwnProperty("sn")&&String(e.flag).startsWith("OperationState_"))};var i=null,n={};return t.pushState=function(e,t){var r=new OperationState(e).clone();history.pushState(r,"",""),i=r,n[e]=t},window.addEventListener("popstate",function(e){if(t.isConstructorOf(i)){var r=e.state&&e.state.sn&&e.state.sn<i.sn,o=n[i.serialNumber];r&&null!=o&&(try2Call(o),delete n[i.serialNumber])}var a=e.state;i=t.isConstructorOf(a)?a:null}),t}(),concatViewOptions=function(e,t){var i=String(e),n=null==t?[]:Object.keys(t),r=n.reduce(function(e,i,n,r){return e+"&"+xEncodeURIComponent(i)+"="+xEncodeURIComponent(t[i])},"");return r.length>0&&(i+="!"+r.substring(1)),i},pushViewState=function(e,t,i){arguments.length<3&&(i=null),arguments.length<2&&(t=getUniqueString()),t=t||getUniqueString();var n=new ViewState(e,t,i).clone();globalLogger.log("↓ {}",JSON.stringify(n)),historyPushPopSupported?history.pushState(n,"","#"+concatViewOptions(e,i)):location.hash=concatViewOptions(e,i),View.currentState=n},replaceViewState=function(e,t,i){arguments.length<3&&(i=null),arguments.length<2&&(t=getUniqueString()),t=t||getUniqueString();var n=new ViewState(e,t,i).clone();globalLogger.log("% {}",JSON.stringify(n)),historyPushPopSupported?history.replaceState(n,"","#"+concatViewOptions(e,i)):location.hash=concatViewOptions(e,i),View.currentState=n},ViewConfiguration=function(e,t){var i,n=e,r=NOT_SUPPLIED;this.getName=function(){return n},this.getValue=function(e){if(NOT_SUPPLIED==r){if(arguments.length<1)return;return e}return r},this.setValue=function(e,t){return arguments.length<2&&(t=!1),(t||NOT_SUPPLIED==r)&&(r=e),this},this.getApplication=function(){return i},this.setApplication=function(e){return"function"!=typeof e?void globalLogger.warn("Configuration application should be of type: 'Function'"):(i=e,this)},this.apply=function(){if("function"==typeof i)try{i.call(this,r)}catch(i){globalLogger.error("Fail to apply configuration: {} = {} for view of id: {}\n{}",e,String(r),t,i),i instanceof Error?console.error(i,i.stack):console.error(i)}return this},this.reflectToDom=function(){return null==t||""==t.trim()?this:View.ifExists(t)?(View.ofId(t).getDomElement().setAttribute("data-viewconfig_"+this.getName(),String(this.getValue())),this):(globalLogger.warn("No view of id '{}' found to reflect view config: {}={}.",t,this.getName(),this.getValue()),this)},Object.freeze(this)},ViewConfigurationSet=function(e){var t={};this.has=function(e){return e in t},this.get=function(i){var n;return i in t?n=t[i]:(n=new ViewConfiguration(i,e),t[i]=n),n},this.applyAll=function(){var e=Object.keys(t).map(function(e){return t[e]});0!=e.length&&setTimeout(function(){e.forEach(function(e){try{e.apply()}catch(e){e instanceof Error?console.error(e,e.stack):console.error(e)}})},0)},this.listAll=function(){return Object.keys(t)}},ViewContext=function(){var e={};defineReadOnlyProperty(this,"has",function(t){return t in e}),defineReadOnlyProperty(this,"set",function(t,i){return e[t]=i,this}),defineReadOnlyProperty(this,"get",function(t){return e[t]}),defineReadOnlyProperty(this,"remove",function(t){var i=e[t];return delete e[t],i}),defineReadOnlyProperty(this,"clear",function(){return e={},this})},ViewLayout=function(){var e={},t=function(){return layout.isLayoutPortrait()},i=t,n=function(e){var t=function(){},n=!0,r=NOT_SUPPLIED;defineReadOnlyProperty(this,"setLayoutAction",function(i){return"function"!=typeof i?(globalLogger.error("Layout action for view of id: {} should be of type: Function.",e),this):(t!=i&&(r=NOT_SUPPLIED,t=i),this)}),defineReadOnlyProperty(this,"getLayoutAction",function(){return t}),defineReadOnlyProperty(this,"doLayout",function(){if("function"!=typeof t)return this;var n=i()?"portrait":"landscape";return r==n?(globalLogger.debug("Skip doing layout for view of id: {} for orientation remains the same.",e),this):(globalLogger.debug("Doing layout for view of id: {}",e),docEle.offsetWidth=docEle.offsetHeight,t(),r=n,this)}),defineReadOnlyProperty(this,"setIfLayoutWhenLayoutChanges",function(e){return n=e,this});var o=this;layout.addLayoutChangeListener(function(){return n?View.ofId(e).isActive()?(globalLogger.debug("Layout changes, doing layout for view of id: {}",e),void o.doLayout()):void globalLogger.debug("Layout changes, but view of id: {} will not respond to this for view is not active.",e):void globalLogger.debug("Layout changes, but view of id: {} will not respond to this for flag: 'layoutWhenLayoutChanges' is {}.",e,n)})};return n.ofId=function(t){if(t in e)return e[t];var i=new n(t);return e[t]=i,i},n.implIsPortrait=function(e){return"function"!=typeof e?(globalLogger.error("Implementation of 'isPortrait' should be of type: Function."),n):(i=e,n)},n}(),View=function(e){if(null===document.querySelector("#"+e+"[data-view=true]"))throw new Error("View of id: "+e+" does not exist(No element matching pattern: '#"+e+"[data-view=true]' found)!");var t={},i=new ViewContext,n=new ViewConfigurationSet(e);eventDrive(this,document.querySelector("#"+e));var r=this.fire;this.fire=function(e,i,n){t[e]=i,r(e,i,n)},defineReadOnlyProperty(this,"logger",Logger.ofName("View#"+e)),defineReadOnlyProperty(this,"config",n),defineReadOnlyProperty(this,"context",i),this.getLatestEventData=function(e){return t[e]},this.getContext=function(){return i},this.clearContext=function(){return i.clear(),this},this.getId=function(){return e},this.getDomElement=function(){return document.querySelector("#"+e)},this.getGroupName=function(){var e=this.getDomElement().getAttribute("data-view-group");return null==e?e:String(e).toLowerCase()},this.find=function(e){return this.getDomElement().querySelector(e)},this.findAll=function(e){return this.getDomElement().querySelectorAll(e)},this.setLayoutAction=function(t,i){return arguments.length<2&&(i=!0),ViewLayout.ofId(e).setIfLayoutWhenLayoutChanges(!!i).setLayoutAction(t),this},this.getLayoutAction=function(){return ViewLayout.ofId(e).getLayoutAction()},this.hasParameter=function(e){if(null===e||void 0===e)return!1;var t=viewParameters[this.getId()];return null!=t&&e in t},this.getParameter=function(e){var t=viewParameters[this.getId()];return arguments.length<1?t:null==t?null:t[e]},this.seekParameter=function(e){if(this.hasParameter(e))return this.getParameter(e);if(View.hasActiveViewOption(e))return View.getActiveViewOption(e);var t=new RegExp("\\b"+e+"\\b=([^&\\?]*)"),i=location.search.match(t);return null==i?null:i=decodeURIComponent(i[1])},this.isReady=function(){return readyViews.indexOf(this.getId())!=-1},this.isActive=function(){return this.getDomElement().classList.contains("active")},this.isDefault=function(){return/true/i.test(this.getDomElement().getAttribute("data-view-default"))},this.isDirectlyAccessible=function(){var e=this.getDomElement().getAttribute("data-view-directly-accessible");return e=null==e?null:e.toLowerCase(),View.isDirectlyAccessible()?"false"!=e:"true"==e},this.setAsDirectlyAccessible=function(e){return arguments.lengt<1&&(e=!0),this.getDomElement().setAttribute("data-view-directly-accessible",String(e)),this},this.setTitle=function(e){return null==e?(this.getDomElement().removeAttribute("data-view-title"),this):(e=String(e),this.getDomElement().setAttribute("data-view-title",e),this.isActive()&&(document.title=e),this)},this.getTitle=function(e){return this.getDomElement().getAttribute("data-view-title")},this.setFallbackViewId=function(e){if(null==e||""==e.trim())return this;if(ifStringEqualsIgnoreCase(":default-view",e)){var t=View.getDefaultView();if(null==t)return globalLogger.error("No default view found."),this;e=t.getId()}else if(/^~/.test(e)){var i=e.substring(1),n=findFirstViewIdOfGroupName(i);if(null==n)return globalLogger.warn("No view of group: {} found.",i),this;e=n}return View.ifExists(e)?this.getId()==e?this:(this.getDomElement().setAttribute("data-view-fallback",e),this):(globalLogger.warn("No view of id: {} found.",e),this)},this.getFallbackView=function(){for(var e=this,t=[this.getId()];;){var i=e.getDomElement().getAttribute("data-view-fallback");if(ifStringEqualsIgnoreCase(":default-view",i))return View.getDefaultView();if(/^~/.test(i)){var n=i.substring(1),r=findFirstViewIdOfGroupName(n);if(null==r)return View.getDefaultView();i=r}if(null==i||!View.ifExists(i))return globalLogger.warn("View: "+e.getId()+" is not permited to access directly, and no fallback configuration found, thus returning the default view"),View.getDefaultView();if(e=View.ofId(i),t.indexOf(e.getId())!=-1)return globalLogger.error("Cyclical reference of view on fallback configuration on view: {}. Chain: {}, view id: {}",this.getId(),t,e.getId()),View.getDefaultView();if(e.isDirectlyAccessible())return e;t.push(i)}},Object.freeze&&Object.freeze(this)};defineReadOnlyProperty(View,"SWITCHTYPE_HISTORYFORWARD","history.forward"),defineReadOnlyProperty(View,"SWITCHTYPE_HISTORYBACK","history.back"),defineReadOnlyProperty(View,"SWITCHTYPE_VIEWNAV","view.nav"),defineReadOnlyProperty(View,"SWITCHTYPE_VIEWCHANGE","view.change");var normalizeSwitchType=function(e){null!=e&&""!=String(e).trim()||(e=View.SWITCHTYPE_VIEWNAV);var t=ifStringEqualsIgnoreCase(e,View.SWITCHTYPE_VIEWNAV),i=ifStringEqualsIgnoreCase(e,View.SWITCHTYPE_VIEWCHANGE),n=ifStringEqualsIgnoreCase(e,View.SWITCHTYPE_HISTORYBACK),r=ifStringEqualsIgnoreCase(e,View.SWITCHTYPE_HISTORYFORWARD);return n||r||t||i||(e=View.SWITCHTYPE_VIEWNAV),e};View.currentState=null,View.Logger=Logger,View.layout=layout,eventDrive(View),View.ofId=function(e){for(var t=0; t<viewInstances.length; t++)if(viewInstances[t].getId().trim()==e.trim())return viewInstances[t];var i=new View(e);return viewInstances.push(i),i},View.ifExists=function(e){for(var t=0;t<viewInstances.length;t++)if(viewInstances[t].getId().trim()==e.trim())return!0;return!1},View.isExisting=View.ifExists,View.listAll=function(e){arguments.length>1&&(e=String(e).toLowerCase());var t=[].concat(viewInstances);return arguments.length<1||""==e?t:t.filter(function(t){return e==t.getGroupName()})},View.listAllGroups=function(){return View.listAll().reduce(function(e,t){var i=t.getGroupName();return null==i||""==String(i).trim()||e.indexOf(i)!=-1?e:(e.push(i),e)},[])},View.setAsDefault=function(e){for(var t=getViewObjs(),i=0;i<t.length;i++)t[i].removeAttribute("data-view-default");var n=getViewObjOfId(e);return null==n?(globalLogger.error("No view dom element of id: {} found to set as default.",e),View):(n.setAttribute("data-view-default","true"),View)},View.isDirectlyAccessible=function(){return ifStringEqualsIgnoreCase("true",docEle.getAttribute("data-view-directly-accessible"))},View.setIsDirectlyAccessible=function(e){return docEle.setAttribute("data-view-directly-accessible",String(!!e).toLowerCase()),View},View.getActiveView=function(){for(var e=0;e<viewInstances.length;e++)if(viewInstances[e].isActive())return viewInstances[e];return null},View.getDefaultView=function(){for(var e=0;e<viewInstances.length;e++)if(viewInstances[e].isDefault())return viewInstances[e];return null},View.setSwitchAnimation=function(e){if(!(e instanceof Function))throw new Error("Invalid argument. Animation of Function is needed.");return viewSwitchAnimation=e,View},View.getSwitchAnimation=function(){return viewSwitchAnimation};var parseParams=function(e){if(null==e||""==String(e).trim())return null;var t=null,i=e.split(/\s*&\s*/);return 0!=i.length&&(t={},i.forEach(function(e){var i=e.split(/\s*=\s*/);t[decodeURIComponent(i[0])]=decodeURIComponent(i[1])})),t},parseViewInfoFromHash=function(e){if(""==e)return null;var t=e.match(/^#([\w\$\-]+)(?:!+(.*))?/);if(null==t)return null;var i=(t[1],parseParams(t[2]));return{viewId:t[1],options:i}};View.getActiveViewOptions=function(){var e=parseViewInfoFromHash(location.hash);return null==e?null:e.options},View.hasActiveViewOption=function(e){var t=View.getActiveViewOptions();return null!=t&&e in t},View.getActiveViewOption=function(e){var t=View.getActiveViewOptions();return null==t?null:t[e]},View.setActiveViewOption=function(e,t){if(null==e||""==String(e).trim())return globalLogger.error("Option name should not be empty."),View;var i=View.getActiveView();if(null==i)return globalLogger.error("No active view to set option {} = {}.",e,t),View;e=String(e).trim(),t=String(t).trim();var n=View.getActiveViewOptions()||{};return n[e]=t,replaceViewState(i.getId(),View.currentState?View.currentState.sn:null,n),View},View.implIsPortrait=function(){return ViewLayout.implIsPortrait.apply(ViewLayout,arguments),View};var switchView=function(e){e=setDftValue(e,{srcView:null,targetView:null,type:View.SWITCHTYPE_VIEWNAV,withAnimation:!0,params:null});var t=e.srcView,i=e.targetView,n=normalizeSwitchType(e.type),r=e.params,o=ifStringEqualsIgnoreCase(n,View.SWITCHTYPE_HISTORYBACK),a=ifStringEqualsIgnoreCase(n,View.SWITCHTYPE_HISTORYFORWARD),u=function(){var e=i.getId();clearViewParameters(e),o?":back"in viewParameters&&(setViewParameters(e,viewParameters[":back"]),delete viewParameters[":back"]):a?":forward"in viewParameters&&(setViewParameters(e,viewParameters[":forward"]),delete viewParameters[":forward"]):setViewParameters(e,r);var u={sourceView:t,type:n,params:r},l=function(e,t){try{i.fire(e,u,t)}catch(t){globalLogger.error("Error occured while firing event: {} with data: {}",e,u),t instanceof Error?console.error(t,t.stack):console.error(t)}};t&&t.getDomElement().classList.remove("active"),t&&t.fire("leave",{targetView:i,type:n}),l("beforeenter",!1),i.getDomElement().classList.add("active"),ViewLayout.ofId(e).doLayout(),i.isReady()||(readyViews.push(e),l("ready",!1)),l("enter",!1),l("afterenter",!1)};View.fire("beforechange",{currentView:t,targetView:i,type:n,params:r}),e.withAnimation&&viewSwitchAnimation?viewSwitchAnimation.call(null,t?t.getDomElement():null,i.getDomElement(),n,u):u(),View.fire("afterchange",{currentView:t,targetView:i,type:n,params:r})},show=function(e,t){if(t=setDftValue(t,{},!0),!View.ifExists(e))throw new Error("Target view: "+e+" does not exist!");var i=View.getActiveView();if(i&&ifStringEqualsIgnoreCase(i.getId(),e))return View;globalLogger.log("{} → {} {}",i?i.getId():null,e,JSON.stringify(t));var n=View.ofId(e);return t.srcView=i,t.targetView=n,switchView(t),View};View.show=show;var findFirstViewIdOfGroupName=function(e){if(null==e||""==String(e).trim())return globalLogger.error("Empty view group name!."),null;e=String(e).trim().toLowerCase();var t=View.listAll(e);if(null==t||0==t.length)return globalLogger.error("No view of group: {} found.",e),null;var i=t.map(function(e){return e.getId()});return targetViewId=i[0],globalLogger.info("Found {} views of group: {}: {}, using the first one: {}.",i.length,e,i,targetViewId),targetViewId};View.navTo=function(e,t){e=e.trim(),t=setDftValue(t,{});var i=View.getActiveView();if(i&&ifStringEqualsIgnoreCase(i.getId(),e))return View;if(ifStringEqualsIgnoreCase(":back",e))return View.back(t),View;if(ifStringEqualsIgnoreCase(":forward",e))return View.forward(t),View;if(ifStringEqualsIgnoreCase(":default-view",e)){var n=View.getDefaultView();if(null==n)return globalLogger.error("No default view found."),View;e=n.getId()}if(/^~/.test(e)){var r=e.substring(1),o=findFirstViewIdOfGroupName(r);if(null==o)return View;if(e=o,i&&ifStringEqualsIgnoreCase(i.getId(),e))return View}return t.type=View.SWITCHTYPE_VIEWNAV,show(e,t),pushViewState(e,null,null==t?null:t.options),View},View.changeTo=function(e,t){t=setDftValue(t,{});var i=View.getActiveView();if(i&&ifStringEqualsIgnoreCase(i.getId(),e))return View;if(ifStringEqualsIgnoreCase(":default-view",e)){var n=View.getDefaultView();if(null==n)return void globalLogger.error("No default view found.");e=n.getId()}if(/^~/.test(e)){var r=e.substring(1),o=findFirstViewIdOfGroupName(r);if(null==o)return View;if(e=o,i&&ifStringEqualsIgnoreCase(i.getId(),e))return View}return t.type=View.SWITCHTYPE_VIEWCHANGE,show(e,t),replaceViewState(e,null,null==t?null:t.options),View},View.back=function(e){return clearViewParameters(":back"),null!=e&&"params"in e&&setViewParameters(":back",e.params),history.go(-1),View},View.forward=function(e){return clearViewParameters(":forward"),null!=e&&"params"in e&&setViewParameters(":forward",e.params),history.go(1),View};var documentTitle=document.title,setDocumentTitle=function(e){return isEmptyString(e,!0)?(globalLogger.warn("Invalid document title: "+e),View):(document.title=documentTitle=e,View)};View.setDocumentTitle=setDocumentTitle,View.onceHistoryBack=function(e){if("function"!=typeof e)throw new Error("Invalid argument! Type of 'Function' is needed.");return OperationState.pushState(randomString(),e),View};var isViewInited=!1,isViewReady=!1,markViewToBeInited,markViewInited,markViewReady,viewInitializer,viewInitializerExecTime,getActiveOrDefaultView=function(){var e=View.getActiveView();return null==e&&(e=View.getDefaultView()),e},getFinalView=function(e){var t=null;return isEmptyString(e,!0)||!View.ifExists(e)?t=getActiveOrDefaultView():(t=View.ofId(e),t.isDirectlyAccessible()||(t=t.getFallbackView())),t},stateChangeListener=function(e){var t=View.getActiveView(),i=null==t?null:t.getId();globalLogger.log("{} Current: {}",historyPushPopSupported?"State poped!":"Hash changed!",t&&t.getId()),globalLogger.log("↑ {}",historyPushPopSupported?JSON.stringify(e.state):location.hash);var n,r,o=View.SWITCHTYPE_VIEWNAV,a=null;if(null==e.state){o=View.SWITCHTYPE_VIEWNAV;var u,l=parseViewInfoFromHash(location.hash);null==l?(a=t,u=i):(n=l.viewId,a=getFinalView(n),u=a.getId());var s=u==n;r=u==i?View.currentState.options:s?l.options:null,replaceViewState(u,null,r),View.show(a.getId(),{type:o,options:r})}else if(ViewState.isConstructorOf(e.state)){var c=e.state;n=c.viewId,View.ifExists(n)?(a=View.ofId(n),r=c.options):(globalLogger.warn("Poped view: "+n+" does not exist, keeping current."),a=t,r=null);var u=a.getId();null!=View.currentState&&(o=c.sn<View.currentState.sn?View.SWITCHTYPE_HISTORYBACK:View.SWITCHTYPE_HISTORYFORWARD),replaceViewState(u,c.sn,r),View.show(a.getId(),{type:o,options:r})}else globalLogger.info("Skip state: {}",e.state)},init=function(){markViewToBeInited(),docEle.setAttribute("data-view-os",env.isIOS?"ios":env.isAndroid?"android":env.isWindowsPhone?"wp":"unknown"),window.addEventListener(historyPushPopSupported?"popstate":"hashchange",stateChangeListener),function(){var e=document.querySelectorAll("["+attr$view_container+"]");if(0==e.length)document.body.setAttribute(attr$view_container,"");else for(var t=1; t<e.length; t++)e[t].removeAttribute(attr$view_container)}();var e=getViewObjs();[].forEach.call(e,function(e){View.ofId(e.id),e.classList.remove("active"),e.classList.add("view"),function(){View.ofId(e.id).on("enter",function(){var t=e.getAttribute("data-view-title");document.title=null==t?documentTitle:t})}()});var t=null;t=function(){for(var t=null,i=-1,n=0; n<e.length; n++)if("true"==e[n].getAttribute("data-view-default")){i=n;break}if(-1!=i){t=e[i];for(var n=i+1; n<e.length; n++)"true"==e[n].getAttribute("data-view-default")&&e[n].removeAttribute("data-view-default")}else 0!=e.length?(t=e[0],t.setAttribute("data-view-default","true")):globalLogger.warn("No view exists to determine the default view.");return t}(),null!=t&&t.classList.add("active"),function(){
touch.addTapListener(docEle,function(e){for(var t,i=e.changedTouches?e.changedTouches[0].target:e.target,n=i;null==n.getAttribute("data-view-rel")&&(n=n.parentNode,n instanceof HTMLElement||(n=null),null!=n););if(null!=n&&(t=n.getAttribute("data-view-rel")),null!=t&&""!=t.trim()){if(!("true"==n.getAttribute("data-view-rel-disabled"))){if(e.preventDefault(),/^(http|https|ftp):\/\//gim.test(t))return void(window.location.href=t);if(/^\s*@+/.test(t)){var r=t.replace(/^\s*@+/,"").trim();return""==r?void globalLogger.warn("Empty file path for data-view-rel: '{}'",t):void(window.location.href=r)}if(ifStringEqualsIgnoreCase(":back",t))return void history.go(-1);if(ifStringEqualsIgnoreCase(":forward",t))return void history.go(1);if(ifStringEqualsIgnoreCase(":default-view",t)){var o=View.getDefaultView();t=null==o?null:o.getId()}var a=null;if(/^~/.test(t)){var u=t.match(/^~([^!]+)(?:!+(.*))?/);if(null==u)return;var l=u[1].trim(),s=parseParams(u[2]),c=findFirstViewIdOfGroupName(l);if(null==c)return;t=c,a=s}else{var f=parseViewInfoFromHash("#"+t);t=f.viewId,a=f.options}var g=View.getActiveView(),w=null==g?null:g.getId();if(null==w||w!=t){var d=n.getAttribute("data-view-rel-type");d=isEmptyString(d,!0)?"nav":d,/^(?:nav)|(?:change)$/.test(d)||(globalLogger.warn("Unknown view switch type: {}. {}",d,n),d="nav"),View[d+"To"](t,{options:a})}}}},{useCapture:!0})}(),globalLogger.info("Marking View as initialized and ready"),markViewInited(),markViewReady(),function(){if(null!=View.currentState)return void globalLogger.debug("Skip showing specified view.");var e=null==t?null:t.id,i=parseViewInfoFromHash(location.hash),n=null==i?null:i.viewId,r=null==i?null:i.options,o=null,a=isEmptyString(e,!0);if(!isEmptyString(n,!0)&&View.ifExists(n)?o=n:(globalLogger.warn("No view of id: {}(specified in the location hash) found, trying to show the default view",n),!a&&View.ifExists(e)?o=e:(globalLogger.warn("No default view(id: {}) found.",e),o=null)),isEmptyString(o,!0))return void globalLogger.warn("Can not determine the initial view!");var u=getFinalView(o);if(null==u)return void globalLogger.error("No final view found for view of id: {}",o);o=u.getId(),o==n||(r=null),globalLogger.info("Showing view: {}",o),replaceViewState(o,null,r);var l=View.getActiveView();switchView({srcView:l==u?null:l,targetView:u,withAnimation:!1,params:null})}()};View.beforeInit=function(){var e=[];return markViewToBeInited=function(){e.forEach(try2exec),e=[]},markViewInited=function(){isViewInited=!0},function(t){return isViewInited?View:e.indexOf(t)!=-1?View:(e.push(t),View)}}(),View.ready=function(){var e=[];return markViewReady=function(){isViewReady=!0,e.forEach(try2exec),e=[]},function(t){return isViewReady?(try2exec(t),View):e.indexOf(t)!=-1?View:(e.push(t),View)}}(),View.setInitializer=function(e,t){if("function"==typeof e){arguments.length<2&&(t="domready");var i="domready, rightnow".split(/\s*,\s*/);i.indexOf(t)==-1&&(globalLogger.warn("Unknown initializer exec time: {}. Supported: {}",t,i),t="domready"),viewInitializer=e,viewInitializerExecTime=t,isViewInited||"rightnow"!=t||(globalLogger.info("Calling specified view initializer right now"),e(init))}},document.addEventListener("DOMContentLoaded",function(){null==viewInitializer?(globalLogger.info("Initializing View automatically"),init()):"domready"==viewInitializerExecTime&&(globalLogger.info("Calling specified view initializer on dom ready"),viewInitializer(init))}),ctx.View=View}(window,"View");