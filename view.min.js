window.View=(function(){var historyPushPopSupported=("pushState" in history)&&(typeof history.pushState=="function");console.log("history.pushState is "+(historyPushPopSupported?"":"not ")+"supported");var readyViews=[];var setDftValue=function(ops,dftOps){ops=ops||{};dftOps=dftOps||{};for(var p in dftOps){if(!(p in ops)){ops[p]=dftOps[p]}}return ops};var eventDrive=(function(){var Event=function(type,data){this.type=type;this.timestamp=new Date().getTime();this.data=data;Object.freeze&&Object.freeze(this)};return function(obj,ctx){(function(obj,ctx){var eventHandlers={};obj.on=function(type,handler){type=type.toLowerCase();eventHandlers[type]=eventHandlers[type]||[];if(eventHandlers[type].indexOf(handler)!=-1){return}eventHandlers[type].push(handler)};obj.off=function(type,handler){type=type.toLowerCase();eventHandlers[type]=eventHandlers[type]||[];var index=eventHandlers[type].indexOf(handler);if(index==-1){return}eventHandlers[type].splice(index,1)};obj.fire=function(type,data){type=type.toLowerCase();var event=new Event(type,data);eventHandlers[type]=eventHandlers[type]||[];eventHandlers[type].forEach(function(handler){handler.call(ctx,event)})}})(obj,ctx)}})();var pushViewState=function(viewId,timestamp){history.pushState({viewId:viewId,timestamp:null==timestamp?Date.now():timestamp},"","#"+viewId)};var replaceViewState=function(viewId,timestamp){history.replaceState({viewId:viewId,timestamp:null==timestamp?Date.now():timestamp},"","#"+viewId)};var ViewNotExistError=function(msg){Error.call(this,msg)};ViewNotExistError.prototype=Object.create(Error.prototype);var Event=function(type,data){this.type=type;this.timestamp=new Date().getTime();this.data=data;Object.freeze&&Object.freeze(this)};var View=function(id){if(null==document.querySelector("#"+id+"[data-view=true]")){throw new ViewNotExistError("View of id: "+id+" does not exist(No element matching pattern: '#"+id+"[data-view=true]' found)!")}var context={};eventDrive(this,document.querySelector("#"+id));var leaveAnimation=function(targetViewId,type,render){};var enterAnimation=function(sourceViewId,type,render){render()};this.getId=function(){return id};this.getDomElement=function(){return document.querySelector("#"+id)};this.getContext=function(){return context};this.clearContext=function(){context={}};this.isReady=function(){return readyViews.indexOf(this.getId())!=-1};this.isActive=function(){return this.getDomElement().classList.contains("active")};this.isDefault=function(){return/true/i.test(this.getDomElement().getAttribute("data-view-default"))};this.isDirectlyAccessible=function(){var keep=document.documentElement.getAttribute("data-view-directly-accessible");keep=null==keep?"false":keep;keep=keep.toLowerCase();var directAccessable=false;if("true"==keep){if("false"==this.getDomElement().getAttribute("data-view-directly-accessible")){directAccessable=false}else{directAccessable=true}}else{if("true"==this.getDomElement().getAttribute("data-view-directly-accessible")){directAccessable=true}else{directAccessable=false}}return directAccessable};this.getFallbackView=function(){var view=this;var idChain=[this.getId()];do{if(view.isDirectlyAccessible()){return view}var fallbackViewId=this.getDomElement().getAttribute("data-view-fallback");if(null==fallbackViewId||!View.isExisting(fallbackViewId)){console.warn("View: "+this.getId()+" is not permited to access directly, and no fallback configuration found, thus returning the default view");return View.getDefaultView()}else{view=View.ofId(fallbackViewId);if(idChain.indexOf(view.getId())!=-1){console.error("cyclical reference of view on fallback configuration on view: "+this.getId());return View.getDefaultView()}idChain.push(fallbackViewId)}}while(true)};this.setLeaveAnimation=function(animation){leaveAnimation=animation};this.getLeaveAnimation=function(){return leaveAnimation};this.setEnterAnimation=function(animation){enterAnimation=animation};this.getEnterAnimation=function(){return enterAnimation};Object.freeze&&Object.freeze(this)};View.SWITCHTYPE_HISTORYFORWARD="history.forward";View.SWITCHTYPE_HISTORYBACK="history.back";View.SWITCHTYPE_VIEWSWITCH="view.switch";var viewInstances=[];View.currentState=null;eventDrive(View);View.ofId=function(id){for(var i=0;i<viewInstances.length;i++){if(viewInstances[i].getId().toLowerCase().trim()==id.toLowerCase().trim()){return viewInstances[i]}}var instance=new View(id);viewInstances.push(instance);return instance};View.isExisting=function(id){for(var i=0;i<viewInstances.length;i++){if(viewInstances[i].getId().toLowerCase().trim()==id.toLowerCase().trim()){return true}}return false};View.getActiveView=function(){for(var i=0;i<viewInstances.length;i++){if(viewInstances[i].isActive()){return viewInstances[i]}}return null};View.getDefaultView=function(){for(var i=0;i<viewInstances.length;i++){if(viewInstances[i].isDefault()){return viewInstances[i]}}return null};View.switchView=function(targetViewId,type,withAnimation){var currentView=View.getActiveView();if(arguments.length<3){withAnimation=true
}if(arguments.length<2){type=View.SWITCHTYPE_VIEWSWITCH}type=type||View.SWITCHTYPE_VIEWSWITCH;if(""==targetViewId.trim()){if(null==View.getDefaultView()){return}else{targetViewId=View.getDefaultView().getId()}}if(!View.isExisting(targetViewId)){console.error("target view: "+targetViewId+" does not exist!");return}console.log(currentView.getId()+" -> "+targetViewId,type);if(currentView.getId().toLowerCase()==targetViewId.toLowerCase()){return}var targetView=View.ofId(targetViewId);type=(type.toLowerCase()==View.SWITCHTYPE_HISTORYFORWARD?View.SWITCHTYPE_HISTORYFORWARD:(type.toLowerCase()==View.SWITCHTYPE_HISTORYBACK?View.SWITCHTYPE_HISTORYBACK:View.SWITCHTYPE_VIEWSWITCH));View.fire("beforechange",{currentView:currentView,targetView:targetView,type:type});var display=function(){currentView.getDomElement().classList.remove("active");targetView.getDomElement().classList.add("active")};currentView.fire("leave",type);if(!withAnimation){display();if(!targetView.isReady()){readyViews.push(targetView.getId());targetView.fire("ready",type)}targetView.fire("enter",type)}else{currentView.getLeaveAnimation()&&currentView.getLeaveAnimation().call(currentView.getDomElement(),targetViewId,type,display);targetView.getEnterAnimation()&&targetView.getEnterAnimation().call(targetView.getDomElement(),currentView.getId(),type,function(){display();if(!targetView.isReady()){readyViews.push(targetView.getId());targetView.fire("ready",type)}targetView.fire("enter",type)})}View.fire("afterchange",{currentView:currentView,targetView:targetView,type:type})};View.updateView=function(targetViewId,type){var state={viewId:targetViewId,timestamp:Date.now()};if(":back"==targetViewId.toLowerCase().trim()){history.go(-1);return}if(":forward"==targetViewId.toLowerCase().trim()){history.go(1);return}if(!View.isExisting(targetViewId)){console.error("target view: "+targetViewId+" does not exist!");return}View.currentState=state;if(historyPushPopSupported){pushViewState(targetViewId);console.log("pushed state by update view",state)}else{location.hash=targetViewId}View.switchView(targetViewId,type)};View.ready=(function(){var isReady=false;var callbacks=[];return function(callback){if(isReady){callback&&callback();return}if(callbacks.indexOf(callback)!=-1){return}callbacks.push(callback)};document.addEventListener("DOMContentLoaded",function(){isReady=true;callbacks.forEach(function(cb){cb&&cb()})})})();var stateChangeListener=function(e){var currentActiveView=View.getActiveView();console.log(historyPushPopSupported?"state poped!":"hash changed!","current: "+currentActiveView.getId());historyPushPopSupported&&console.log("poped state",JSON.stringify(e.state));var tarId,type=View.SWITCHTYPE_VIEWSWITCH,targetView=null;if(!historyPushPopSupported||null==e.state){tarId=location.hash.replace(/^#/,"").toLowerCase();if(""==tarId){targetView=View.getDefaultView()}else{if(!View.isExisting(tarId)){targetView=View.getDefaultView()}else{if(View.ofId(tarId).isDirectlyAccessible()){targetView=View.ofId(tarId)}else{targetView=View.ofId(tarId).getFallbackView()}}}type=View.SWITCHTYPE_VIEWSWITCH;location.hash=targetView.getId()}else{var popedNewState=e.state;tarId=popedNewState.viewId;if(null==tarId||!View.isExisting(tarId)){targetView=View.getDefaultView()}else{targetView=View.ofId(tarId)}if(View.currentState!=null){type=popedNewState.timestamp<View.currentState.timestamp?View.SWITCHTYPE_HISTORYBACK:View.SWITCHTYPE_HISTORYFORWARD}View.currentState=popedNewState;replaceViewState(targetView.getId(),popedNewState.timestamp)}targetView&&View.switchView(targetView.getId(),type)};var init=function(){[].forEach.call(document.querySelectorAll("*[data-view=true]"),function(viewObj){View.ofId(viewObj.id)});[].forEach.call(document.querySelectorAll("*[data-view=true]"),function(viewObj){viewObj.classList.add("view")});(function(){var defaultViewObj=null;var defaultViewObjs=document.querySelectorAll("*[data-view-default=true][data-view=true]");if(0==defaultViewObjs.length){defaultViewObj=document.querySelector("*[data-view=true]");if(null==defaultViewObj){console.warn("No view found!")}else{defaultViewObj.setAttribute("data-view-default","true")}}else{defaultViewObj=defaultViewObjs[0];for(var i=1;i<defaultViewObjs.length;i++){defaultViewObjs[i].removeAttribute("data-view-default")}}})();(function(){document.addEventListener("touchend",function(e){var eventTarget=e.changedTouches[0].target;var targetViewId;var tmp=eventTarget;while(null==tmp.getAttribute("data-view-rel")){tmp=tmp.parentNode;if(!(tmp instanceof HTMLElement)){tmp=null}if(null==tmp){break}}if(null!=tmp){targetViewId=tmp.getAttribute("data-view-rel")}if(null==targetViewId){return}var isViewRelDisabled=false;tmp=eventTarget;while(null==tmp.getAttribute("data-view-rel-disabled")){tmp=tmp.parentNode;if(!(tmp instanceof HTMLElement)){tmp=null}if(null==tmp){break}}if(null!=tmp){isViewRelDisabled="true"==tmp.getAttribute("data-view-rel-disabled")}if(isViewRelDisabled){return}e.preventDefault();if(":back"==targetViewId.toLowerCase().trim()){history.go(-1);
return}if(":forward"==targetViewId.toLowerCase().trim()){history.go(1);return}View.updateView(targetViewId,View.SWITCHTYPE_VIEWSWITCH)},true)})();(function(){var targetViewId=location.hash.replace(/^#/i,"").toLowerCase();var targetView=null;if(""==targetViewId){targetView=View.getDefaultView()}else{if(!View.isExisting(targetViewId)){targetView=View.getDefaultView()}else{if(View.ofId(targetViewId).isDirectlyAccessible()){targetView=View.ofId(targetViewId)}else{targetView=View.ofId(targetViewId).getFallbackView()}}}if(null!=targetView){if(historyPushPopSupported){replaceViewState(targetView.getId())}else{location.hash=targetView.getId()}targetView.getDomElement().classList.add("active")}})();window.addEventListener(historyPushPopSupported?"popstate":"hashchange",stateChangeListener)};document.addEventListener("DOMContentLoaded",function(){init();var activeView=View.getActiveView();if(activeView){readyViews.push(activeView.getId());activeView.fire("ready",View.SWITCHTYPE_VIEWSWITCH);activeView.fire("enter",View.SWITCHTYPE_VIEWSWITCH)}});return View})();